name: Build IPA

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest

    - name: Setup CocoaPods
      run: |
        gem install cocoapods
        pod install

    - name: Setup SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint --strict || echo "SwiftLint found issues, continuing..."

    - name: Build IPA
      run: |
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏
        mkdir -p build

        # –°–±–æ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞
        echo "üî® –°–±–æ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞..."
        xcodebuild archive \
          -workspace NextcloudTalk.xcworkspace \
          -scheme NextcloudTalk \
          -configuration Debug \
          -sdk iphoneos \
          -archivePath build/NextcloudTalk.xcarchive \
          DEVELOPMENT_TEAM=${{ secrets.DEVELOPMENT_TEAM }} \
          CODE_SIGN_IDENTITY="iPhone Developer"

        # –≠–∫—Å–ø–æ—Ä—Ç IPA
        echo "üì¶ –≠–∫—Å–ø–æ—Ä—Ç IPA..."
        xcodebuild -exportArchive \
          -archivePath build/NextcloudTalk.xcarchive \
          -exportOptionsPlist exportOptionsDevelopment.plist \
          -exportPath build

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: NextcloudTalk-IPA
        path: build/NextcloudTalk.ipa
        retention-days: 30

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/
          *.log